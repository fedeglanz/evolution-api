# Registro de Cambios - 9 de Septiembre 2025

## [10:30] - Implementaci√≥n Sistema de Planes MercadoPago

**Descripci√≥n**: Se implement√≥ sistema completo de planes configurables con MercadoPago, permitiendo crear, asociar o actualizar planes existentes directamente desde Platform Admin.

**Archivos modificados**:
- `backend/migrations/add_payment_gateways_to_plans.sql` - Agreg√≥ campos mercadopago_plan_id, mercadopago_config, mercadopago_enabled a tabla plans
- `backend/src/services/paymentPlanService.js` - Nuevo servicio completo para gesti√≥n de planes en pasarelas
- `backend/src/controllers/platformPlanController.js` - Agreg√≥ endpoints configureMercadoPago y updateMercadoPagoPlan
- `frontend/whatsapp-bot-frontend/src/components/PaymentGatewayModal.jsx` - Modal completo con 3 acciones: crear/asociar/actualizar

**Decisiones importantes**: 
- Los planes pueden configurarse din√°micamente con par√°metros espec√≠ficos de MP (billing_day, free_trial, m√©todos de pago)
- Sistema soporta tanto creaci√≥n autom√°tica como asociaci√≥n de planes existentes
- Fallback HTTP para operaci√≥n UPDATE si SDK no la soporta

## [11:45] - Integraci√≥n Flujo de Suscripci√≥n con Planes

**Descripci√≥n**: Se actualiz√≥ createMercadoPagoSubscription para usar planes configurados en lugar de crear preapprovals directamente.

**Archivos modificados**:
- `backend/src/services/billingService.js` - M√©todo createMercadoPagoSubscription actualizado para verificar y usar plan.mercadopago_plan_id

**Decisiones importantes**:
- Ahora requiere que el plan tenga mercadopago_enabled=true y mercadopago_plan_id configurado
- Usa configuraci√≥n del plan (billing_day, free_trial, payment_methods) en lugar de valores hardcoded
- Conversi√≥n USD‚ÜíARS usando tasa configurable por plan

## [14:20] - Configuraci√≥n Webhooks MercadoPago

**Descripci√≥n**: Se implement√≥ sistema completo de webhooks para procesar eventos de suscripciones y pagos autom√°ticamente.

**Archivos modificados**:
- `backend/src/services/billingService.js` - M√©todos handleSubscriptionWebhook, handlePaymentWebhook, recordMercadoPagoPayment

**Decisiones importantes**:
- Soporta m√∫ltiples tipos de eventos: subscription_preapproval, payment, preapproval
- Mapea estados de MP a sistema interno (authorized‚Üíactive, paused‚Üípaused, etc.)
- Registra transacciones autom√°ticamente en billing_transactions

## [15:30] - Problema: card_token_id requerido

**Descripci√≥n**: Al probar suscripci√≥n con plan configurado, MercadoPago devolvi√≥ error "card_token_id is required". Se identific√≥ que los planes requieren tokenizaci√≥n de tarjetas.

**TODOs identificados**:
- Implementar flujo completo de tokenizaci√≥n de tarjetas MercadoPago
- API para obtener/gestionar tarjetas guardadas
- Componente frontend para selecci√≥n/agregado de tarjetas
- Integrar card_token_id en createMercadoPagoSubscription

## [16:00] - Actualizaci√≥n de Credenciales Test

**Descripci√≥n**: Se identific√≥ que las credenciales TEST actuales son inv√°lidas, necesitan actualizarse desde dashboard MercadoPago.

**Archivos involucrados**:
- `backend/.env` - MERCADOPAGO_ACCESS_TOKEN actual devuelve "unauthorized"

**Estado actual**: 
- Sistema de planes implementado y funcional
- Webhooks configurados
- Bloqueado por credenciales inv√°lidas y requisito de tokenizaci√≥n
- Usuario test necesario: vendedor y comprador en MercadoPago

## [17:30] - Implementaci√≥n Completa Flujo de Tokenizaci√≥n

**Descripci√≥n**: Se implement√≥ el sistema completo de tokenizaci√≥n de tarjetas para MercadoPago, resolviendo el error "card_token_id is required".

**Archivos modificados - Backend**:
- `backend/src/services/mercadopagoCardService.js` - Servicio completo para gesti√≥n de tarjetas MP
- `backend/src/controllers/mercadopagoCardController.js` - Controller con 5 endpoints para tarjetas
- `backend/src/routes/mercadopagoCards.js` - Rutas `/api/mercadopago/*`
- `backend/migrations/add_mercadopago_customer_id.sql` - Campo customer_id en companies
- `backend/src/services/billingService.js` - Soporte para card_token_id en suscripciones
- `backend/src/controllers/billingController.js` - Pasar card_token_id al crear suscripci√≥n

**Archivos modificados - Frontend**:
- `frontend/src/components/CardSelectionModal.jsx` - Modal completo para selecci√≥n de tarjetas
- `frontend/src/components/CheckoutModal.jsx` - Integraci√≥n con flujo condicional MP vs Stripe
- `frontend/src/services/mercadopago.js` - Servicio para APIs de tarjetas
- `frontend/src/services/billing.js` - Soporte para card_token_id

**Flujo implementado**:
1. **Crear/obtener customer MP**: POST /api/mercadopago/customer
2. **Obtener tarjetas guardadas**: GET /api/mercadopago/cards  
3. **Seleccionar tarjeta existente**: POST /api/mercadopago/card-token
4. **Agregar tarjeta nueva**: POST /api/mercadopago/card-token/new
5. **Crear suscripci√≥n con token**: POST /api/billing/create-subscription (con card_token_id)

**Decisiones importantes**:
- CardSelectionModal se abre autom√°ticamente para pagos MercadoPago
- Soporte completo para tarjetas guardadas y nuevas
- Error handling espec√≠fico para c√≥digos de seguridad inv√°lidos
- Integraci√≥n seamless con flujo existente de Stripe

**Estado final**: 
- ‚úÖ Flujo completo de tokenizaci√≥n implementado
- ‚úÖ Frontend y backend integrados
- ‚úÖ Error de JavaScript corregido
- üîÑ Pendiente: probar con credenciales v√°lidas de MercadoPago