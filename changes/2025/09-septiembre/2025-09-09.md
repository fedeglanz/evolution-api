# Registro de Cambios - 9 de Septiembre 2025

## [10:30] - Implementación Sistema de Planes MercadoPago

**Descripción**: Se implementó sistema completo de planes configurables con MercadoPago, permitiendo crear, asociar o actualizar planes existentes directamente desde Platform Admin.

**Archivos modificados**:
- `backend/migrations/add_payment_gateways_to_plans.sql` - Agregó campos mercadopago_plan_id, mercadopago_config, mercadopago_enabled a tabla plans
- `backend/src/services/paymentPlanService.js` - Nuevo servicio completo para gestión de planes en pasarelas
- `backend/src/controllers/platformPlanController.js` - Agregó endpoints configureMercadoPago y updateMercadoPagoPlan
- `frontend/whatsapp-bot-frontend/src/components/PaymentGatewayModal.jsx` - Modal completo con 3 acciones: crear/asociar/actualizar

**Decisiones importantes**: 
- Los planes pueden configurarse dinámicamente con parámetros específicos de MP (billing_day, free_trial, métodos de pago)
- Sistema soporta tanto creación automática como asociación de planes existentes
- Fallback HTTP para operación UPDATE si SDK no la soporta

## [11:45] - Integración Flujo de Suscripción con Planes

**Descripción**: Se actualizó createMercadoPagoSubscription para usar planes configurados en lugar de crear preapprovals directamente.

**Archivos modificados**:
- `backend/src/services/billingService.js` - Método createMercadoPagoSubscription actualizado para verificar y usar plan.mercadopago_plan_id

**Decisiones importantes**:
- Ahora requiere que el plan tenga mercadopago_enabled=true y mercadopago_plan_id configurado
- Usa configuración del plan (billing_day, free_trial, payment_methods) en lugar de valores hardcoded
- Conversión USD→ARS usando tasa configurable por plan

## [14:20] - Configuración Webhooks MercadoPago

**Descripción**: Se implementó sistema completo de webhooks para procesar eventos de suscripciones y pagos automáticamente.

**Archivos modificados**:
- `backend/src/services/billingService.js` - Métodos handleSubscriptionWebhook, handlePaymentWebhook, recordMercadoPagoPayment

**Decisiones importantes**:
- Soporta múltiples tipos de eventos: subscription_preapproval, payment, preapproval
- Mapea estados de MP a sistema interno (authorized→active, paused→paused, etc.)
- Registra transacciones automáticamente en billing_transactions

## [15:30] - Problema: card_token_id requerido

**Descripción**: Al probar suscripción con plan configurado, MercadoPago devolvió error "card_token_id is required". Se identificó que los planes requieren tokenización de tarjetas.

**TODOs identificados**:
- Implementar flujo completo de tokenización de tarjetas MercadoPago
- API para obtener/gestionar tarjetas guardadas
- Componente frontend para selección/agregado de tarjetas
- Integrar card_token_id en createMercadoPagoSubscription

## [16:00] - Actualización de Credenciales Test

**Descripción**: Se identificó que las credenciales TEST actuales son inválidas, necesitan actualizarse desde dashboard MercadoPago.

**Archivos involucrados**:
- `backend/.env` - MERCADOPAGO_ACCESS_TOKEN actual devuelve "unauthorized"

**Estado actual**: 
- Sistema de planes implementado y funcional
- Webhooks configurados
- Bloqueado por credenciales inválidas y requisito de tokenización
- Usuario test necesario: vendedor y comprador en MercadoPago