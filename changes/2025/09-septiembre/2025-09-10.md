# Changes Log - 2025-09-10

## [14:30] - Fix MercadoPago Public Endpoints para Registro de Usuario

**DescripciÃ³n**: Resolvido problema crÃ­tico donde endpoints pÃºblicos de MercadoPago para registro fallaban por error `Cannot destructure property 'companyId' of 'req.user' as it is undefined`. 

**Problema identificado**:
- Los endpoints pÃºblicos (`/api/public/mercadopago/customer`) no tienen `req.user` porque no requieren autenticaciÃ³n
- El controller intentaba acceder a `req.user.companyId` que no existe en flujo de registro
- Frontend mezclaba endpoints autenticados con pÃºblicos durante onboarding

**Archivos modificados**:
- `backend/src/controllers/mercadopagoCardController.js`:
  - âœ… Agregado mÃ©todo `getOrCreateCustomerPublic()` sin dependencia de `req.user`
  - âœ… MÃ©todo separado para onboarding vs usuarios autenticados
  - âœ… Bind correcto del nuevo mÃ©todo en constructor

- `backend/src/services/mercadopagoCardService.js`:
  - âœ… Agregado mÃ©todo `createCustomerForOnboarding()` sin requerir `companyId`
  - âœ… Crear customers MercadoPago sin asociar a empresa (se asociarÃ¡ despuÃ©s del registro)
  - âœ… Metadata con `source: 'onboarding'` para identificar origen

- `backend/src/routes/publicMercadopago.js`:
  - âœ… Cambiado endpoint `/customer` para usar `getOrCreateCustomerPublic` en lugar de `getOrCreateCustomer`

- `frontend/src/components/CardSelectionModal.jsx`:
  - âœ… LÃ³gica condicional para usar `onboardingPayments` cuando `isRegistration=true`
  - âœ… Mantiene compatibilidad con flujo autenticado usando `mercadopagoService`
  - âœ… MÃ©todos `loadCustomerAndCards` y `handleAddNewCard` actualizados

- `frontend/src/components/CheckoutModal.jsx`:
  - âœ… Agregado prop `isRegistration` a `CardSelectionModal`
  - âœ… SeparaciÃ³n clara entre flujo registro vs flujo normal
  - âœ… Durante registro: no redirecciones, todo vÃ­a callback `onSuccess`
  - âœ… Durante autenticado: mantiene redirecciones a checkout URLs

- `frontend/src/pages/Register.jsx`:
  - âœ… `handlePaymentSuccess` extendido para incluir datos MercadoPago
  - âœ… Incluye `cardTokenId`, `paymentProvider`, `paymentRegion` en userData
  - âœ… Logging mejorado para debugging del flujo completo

**Arquitectura implementada para registro**:
```
Frontend Registro (isRegistration=true)
    â†“
CardSelectionModal â†’ onboardingPayments.createMercadoPagoCustomer()
    â†“
CheckoutModal â†’ Mock response con datos tokenizados
    â†“
Register.handlePaymentSuccess â†’ authService.register() con payment data
```

**Vs flujo autenticado normal**:
```
Frontend Billing (isRegistration=false)
    â†“
CardSelectionModal â†’ mercadopagoService.createOrGetCustomer()
    â†“
CheckoutModal â†’ billingService.createSubscription()
    â†“
Redirect a MercadoPago checkout URL
```

**Decisiones importantes**:
1. **SeparaciÃ³n total de flujos**: Registro vs billing usan servicios completamente diferentes
2. **Endpoints pÃºblicos**: No requieren autenticaciÃ³n para onboarding
3. **Customer sin empresa**: Durante registro se crea customer que se asociarÃ¡ despuÃ©s
4. **No redirecciones en registro**: Todo manejado vÃ­a callbacks para mantener UX

**Testing realizado**:
- âœ… Endpoints pÃºblicos funcionando sin error `companyId undefined`
- âœ… CardSelectionModal usa servicio correcto segÃºn `isRegistration`
- âœ… CheckoutModal no hace redirecciones durante registro
- ðŸ”§ Pendiente: Test completo flujo registro end-to-end

**TODOs**:
- Test completo del flujo de registro con MercadoPago
- Verificar que el backend register endpoint puede manejar los nuevos campos de payment data
- Test de asociaciÃ³n customerâ†’company despuÃ©s del registro exitoso

**Estado actual**: 
- âœ… Error `companyId undefined` resuelto
- âœ… Arquitectura dual (registro vs autenticado) implementada
- âœ… Frontend preparado para usar endpoints pÃºblicos correctamente
- ðŸ”§ Pendiente testing completo post-deploy

**PrÃ³ximo deploy**: Backend listo para push, frontend permanece local para testing.